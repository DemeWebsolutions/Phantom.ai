# Combined Compliance & Auto-Resolve (robust)
# Runs PHPCS (WPCS) + PHPCompatibility, Semgrep, PHPStan.
# Ensures Composer plugin is allowed before install to avoid composer exit code 2.
on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  checks: write

jobs:
  compliance:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print Git info & workspace preview
        run: |
          echo "Branch: $(git rev-parse --abbrev-ref HEAD || true)"
          echo "Commit: $(git rev-parse --short HEAD || true)"
          git --no-pager log -n 5 --pretty=oneline || true
          git ls-files | sed -n '1,200p' || true

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, json
          coverage: none

      - name: Prepare artifacts dir
        run: |
          mkdir -p artifacts
          mkdir -p artifacts/patches
          ls -la artifacts || true

      - name: Cache composer vendor
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Allow required Composer plugin(s)
        run: |
          # Allow only the PHPCS installer plugin so composer install can run non-interactively.
          composer --version
          composer config --no-plugins allow-plugins.dealerdirect/phpcodesniffer-composer-installer true || true
        env:
          COMPOSER_ALLOW_SUPERUSER: 1

      - name: Install composer dependencies
        run: |
          composer --version
          composer install --no-interaction --no-progress --prefer-dist || (composer diagnose && exit 1)
        env:
          COMPOSER_ALLOW_SUPERUSER: 1

      - name: Ensure placeholder artifacts exist (if tools missing)
        run: |
          for f in phpcs.json phpcompat.json semgrep.json phpstan.json; do
            if [ ! -f artifacts/$f ]; then echo "{}" > artifacts/$f; fi
          done

      - name: Run PHPCS -> artifacts/phpcs.json
        run: |
          set -o pipefail
          if [ -x vendor/bin/phpcs ]; then
            vendor/bin/phpcs --standard=WordPress --report=json --report-file=artifacts/phpcs.json . || true
          else
            echo '{}' > artifacts/phpcs.json
          fi
        continue-on-error: true

      - name: Run PHPCompatibility (PHPCS) -> artifacts/phpcompat.json
        run: |
          set -o pipefail
          if [ -x vendor/bin/phpcs ]; then
            vendor/bin/phpcs --standard=PHPCompatibility --runtime-set testVersion 7.4-8.1 --report=json --report-file=artifacts/phpcompat.json . || true
          else
            echo '{}' > artifacts/phpcompat.json
          fi
        continue-on-error: true

      - name: Run Semgrep -> artifacts/semgrep.json
        uses: returntocorp/semgrep-action@v1
        with:
          config: 'p/ci'
          output: artifacts/semgrep.json
        continue-on-error: true

      - name: Run PHPStan -> artifacts/phpstan.json
        run: |
          set -o pipefail
          if [ -x vendor/bin/phpstan ]; then
            vendor/bin/phpstan analyse --error-format=json -l 5 --no-progress --no-interaction . > artifacts/phpstan.json || true
          else
            echo '{}' > artifacts/phpstan.json
          fi
        continue-on-error: true

      - name: Build unified phantom-report.json
        run: |
          if command -v jq >/dev/null 2>&1; then
            jq -n \
            --slurpfile phpcs artifacts/phpcs.json \
            --slurpfile phpcompat artifacts/phpcompat.json \
            --slurpfile semgrep artifacts/semgrep.json \
            --slurpfile phpstan artifacts/phpstan.json \
            '{
              generated_at: (now | todate),
              generator: "combined-compliance-workflow",
              phpcs: $phpcs[0],
              phpcompat: $phpcompat[0],
              semgrep: $semgrep[0],
              phpstan: $phpstan[0]
            }' > artifacts/phantom-report.json
          else
            php -r '
            $out = [
              "generated_at" => gmdate("c"),
              "generator" => "combined-compliance-workflow",
              "phpcs" => json_decode(file_get_contents("artifacts/phpcs.json"), true),
              "phpcompat" => json_decode(file_get_contents("artifacts/phpcompat.json"), true),
              "semgrep" => json_decode(file_get_contents("artifacts/semgrep.json"), true),
              "phpstan" => json_decode(file_get_contents("artifacts/phpstan.json"), true)
            ];
            file_put_contents("artifacts/phantom-report.json", json_encode($out, JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES));
            '
          fi

      - name: Upload artifacts bundle
        uses: actions/upload-artifact@v4
        with:
          name: phantom-artifacts
          path: artifacts/

      - name: Final artifact preview
        run: |
          head -n 200 artifacts/phantom-report.json || true
          for f in artifacts/phpcs.json artifacts/phpcompat.json artifacts/semgrep.json artifacts/phpstan.json; do
            echo "---- $f ----"
            head -n 80 "$f" || true
          done
        continue-on-error: true
